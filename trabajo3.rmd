---
title: "Trabajo 3"
author: "Samuel Cardenete Rodríguez y Juan José Sierra González"
date: "11 de mayo de 2017"
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/")
set.seed(5)

#library("AppliedPredictiveModeling",lib.loc="/Library/Frameworks/R.framework/Versions/3.3/Resources/library")

#library("caret", lib.loc="/Library/Frameworks/R.framework/Versions/3.3/Resources/library")
#library("leaps", lib.loc="/Library/Frameworks/R.framework/Versions/3.3/Resources/library")

```

##Introducción:
Para la realización de esta práctica obtendremos el ajuste de de modelos lineales basados en dos problemas centrados en dos conjuntos de datos diferentes. En primer lugar trabajaremos con un problema de clasificación, basado en el conjunto de datos "South African Heart Disease", para el reconocimiento de enfermedades cardiovasculares en una población de sudáfrica; y un problema de regresión, basado en el conjunto de datos "Los Angeles Ozone", para predecir los niveles de Ozono en Los angeles.
\newline

Comenzaremos primeramente abordando el problema de clasificación:

##Clasificación: "South African Heart Disease"
En este caso nos encontramos frente a un problema de clasificación, tal y como hemos visto anteriormente. Se trata de un conjunto de datos que clasifica individuos de una población de Sudáfrica, indicando si tienen o no riesgo de padecer una enfermedad del corazón en función de los hábitos de vida (consumo de tabaco, obesidad, alcohol...).
\newline
Para comenzar a buscar el modelo lineal que mejor se adapte a nuestro problema, comenzaremos seleccionando nuestro conjunto de entrenamiento y de prueba.

###Lectura de datos:
Procedemos a la lectura de datos tanto de la base de datos de clasificación 'South African Heart Disease', como para la de regresión 'Los Angeles Ozone'. \newline

```{r}
datos_ozone = read.csv("./datos/LAozone.data")
datos_sudafrica = read.csv("./datos/africa.data")
```

Si analizamos los datos obtenidos, podemos observar que existe un atributo, 'row.names', perteneciente a nuestro dataset de 'South African Heart Disease' que actúa como clave primaria, es decir, como identificador, así que dicho atributo nos es inútil para el aprendizaje de nuestro modelo lineal, y por tanto lo suprimimos:

```{r}
datos_sudafrica = datos_sudafrica[,-which(names(datos_sudafrica) == "row.names")]
```

Si seguimos con en análisis de los atributos observando sus tipos, nos damos cuenta de que existe un atributo de tipo factor, es decir una variable cualitativa, 'famhist', que nos indica el historial familiar de enfermedades de corazón, clasificado cmo 'ausente' o 'presente':

```{r}
class(datos_sudafrica$famhist)
```
Por tanto procedemos a interpretarlo de forma numérica, de forma que sustituimos 'presente' por 1 y 'ausente' por 0:
```{r}


#Cambiamos la columna 'famhist' que contiene caracteres por su equivalente en valores numéricos:
datos_sudafrica = data.frame(famhist = (ifelse(datos_sudafrica$famhist=="Absent",0,1)),datos_sudafrica[,-which(names(datos_sudafrica) == "famhist")])
```

###Conjuntos de training y test usados
En primer lugar, realizaremos una división del conjunto de datos. Para el conjunto 'train' de entrenamiento emplearemos el 80% del conjunto total de los datos, de forma que el 20% restante será empleado para test. En caso de realizar validación más adelante explicaremos el cómo.\newline
Procedemos al particionamiento de los datos, así como a su lectura:
```{r, include=FALSE}



#Si queremos obtener un conjunto de indices train para luego ejecutar un modelo lineal sobre el train:
train = sample (nrow(datos_sudafrica), round(nrow(datos_sudafrica)*0.8))
sudafrica_train = datos_sudafrica[train,]
sudafrica_test = datos_sudafrica[-train,]
```

Ahora procedemos a ver si reducimos los datos, para ello aplicamos el PCA (lo que signifique..) sobre el conjunto train, y con las transformaciones indicadas en los parametros. tras esto observamos el parametro rotation, como influye la varianza de cada parámetro en los parámetros preprocesator mediante PCA obtenidos (PC1, PC2...)

```{r}
sudafricaTrans = preProcess(sudafrica_train, method = c("BoxCox", "center", "scale", "pca"),thresh = 0.9)
summary(sudafricaTrans$rotation)

nearZeroVar(sudafricaTrans$rotation)
```

Como comprobamos con la función near cero observamos que no existe ningun atributo cuyas varianzas respecto a las demás sean todas cercanas a cero, por lo que quitar un atributo no sería aconsejable pues no podemos asegurar que no sea importante. Por tanto nos quedamos con 10 atributos.\newline

Para conlcuir el preprocesamiento de los datos, los centramos, aplicamos el BoxCox y los escalamos:

```{r}
sudafricaTrans = preProcess(sudafrica_train[,-ncol(sudafrica_train)], method = c("BoxCox", "center", "scale"),thresh = 0.9)
sudafrica_train[,-ncol(sudafrica_train)] =predict(sudafricaTrans,sudafrica_train[,-ncol(sudafrica_train)])
```

Para realizarar un modelo, vemos cuales son las características más representativao (varianza mayor):

```{r}
regsub_sudafrica =regsubsets(datos_sudafrica[,-ncol(datos_sudafrica)], datos_sudafrica[,ncol(datos_sudafrica)])

summary(regsub_sudafrica)


```

Ahora que sabemos cuáles son las características más recomendables para realizar modelos, vamos a construir una serie de ellos con algunas de estas características y validaremos con el conjunto de test para comprobar los errores que reflejan.

```{r}
###########################################################
# ESTO ES UNA CHAPUZA Y NO SABEMOS SI HABRÁ QUE HACERLO ASÍ Y/O AQUÍ
##########################################################

sudafricaTrans = preProcess(sudafrica_test[,-ncol(sudafrica_test)], method = c("BoxCox", "center", "scale"),thresh = 0.9)
sudafrica_test[,-ncol(sudafrica_test)] =predict(sudafricaTrans,sudafrica_test[,-ncol(sudafrica_test)])
```

Para empezar calculamos un modelo lineal de forma que predecimos chd (etiquetas) a partir del atributo más representativo, en nuestro caso como hemos comprobado 'age'. \newline

Una vez calculado el modelo, empleamos la función predict para obtener la probabilidad de cada etiqueta.
Como en nuestro caso 

```{r}
m1_sudafrica = lm(chd ~ age, data=sudafrica_train)

prob_test_m1sud = predict(m1_sudafrica, data.frame(sudafrica_test[,-ncol(sudafrica_test)]), type="response")

pred_test_m1sud = rep(0, length(prob_test_m1sud))
 # predicciones por defecto 0
pred_test_m1sud[prob_test_m1sud >=0.5] = 1
 # >= 0.5 clase 1
table(pred_test_m1sud, sudafrica_test[,ncol(sudafrica_test)])

eout_m1sud = mean(pred_test_m1sud != sudafrica_test[,ncol(sudafrica_test)])
eout_m1sud
```
Obtenemos un error de 0.35, para nada aceptable, por tanto busquemos un modelo diferente empleando otra carasterística, la siguiente más representativa para el cálculo del modelo que en nuestro caso es famhist:

```{r}
sudafrica_frame_1 = data.frame(sudafrica_train[,which(names(sudafrica_train) == "chd" | names(sudafrica_train) == "age" | names(sudafrica_train) == "famhist")])

m1_sudafrica = lm(chd ~ . , data=sudafrica_frame_1)

prob_test_m1sud = predict(m1_sudafrica, data.frame(sudafrica_frame_1[,-which(names(sudafrica_frame_1) == "chd")]), type="response")

pred_test_m1sud = rep(0, length(prob_test_m1sud))
 # predicciones por defecto 0
pred_test_m1sud[prob_test_m1sud >=0.5] = 1
 # >= 0.5 clase 1
table(pred_test_m1sud, sudafrica_frame_1[,which(names(sudafrica_frame_1) == "chd")])

eout_m1sud = mean(pred_test_m1sud != sudafrica_frame_1[,which(names(sudafrica_frame_1) == "chd")])

eout_m1sud
```

```{r}
sudafrica_frame_2 = data.frame(sudafrica_train[,which(names(sudafrica_train) == "chd" | names(sudafrica_train) == "age" | names(sudafrica_train) == "famhist" | names(sudafrica_train) == "ldl")])

m2_sudafrica = lm(chd ~ . , data=sudafrica_frame_2)

prob_test_m2sud = predict(m2_sudafrica, data.frame(sudafrica_frame_2[,-which(names(sudafrica_frame_2) == "chd")]), type="response")

pred_test_m2sud = rep(0, length(prob_test_m2sud))
 # predicciones por defecto 0
pred_test_m2sud[prob_test_m2sud >=0.5] = 1
 # >= 0.5 clase 1
table(pred_test_m2sud, sudafrica_frame_2[,which(names(sudafrica_frame_2) == "chd")])

eout_m2sud = mean(pred_test_m2sud != sudafrica_frame_2[,which(names(sudafrica_frame_2) == "chd")])

eout_m2sud
```

```{r}
sudafrica_frame_3 = data.frame(sudafrica_train[,which(names(sudafrica_train) == "chd" | names(sudafrica_train) == "age" | names(sudafrica_train) == "famhist" | names(sudafrica_train) == "ldl" | names(sudafrica_train) == "typea")])

m3_sudafrica = lm(chd ~ . , data=sudafrica_frame_3)

prob_test_m3sud = predict(m3_sudafrica, data.frame(sudafrica_frame_3[,-which(names(sudafrica_frame_3) == "chd")]), type="response")

pred_test_m3sud = rep(0, length(prob_test_m3sud))
 # predicciones por defecto 0
pred_test_m3sud[prob_test_m3sud >=0.5] = 1
 # >= 0.5 clase 1
table(pred_test_m3sud, sudafrica_frame_3[,which(names(sudafrica_frame_3) == "chd")])

eout_m3sud = mean(pred_test_m3sud != sudafrica_frame_3[,which(names(sudafrica_frame_3) == "chd")])

eout_m3sud
```